- name: sudo
  hosts: all
  sudo: yes
  vars:
    my_ssh_key: /Users/pavel/.ssh/id_ecdsa.pub
    user: pavel
  tasks:
  - set_fact:
      sudoers: /usr/local/etc/sudoers
    when: ansible_distribution == 'FreeBSD'
  - set_fact:
      sudoers: /etc/sudoers
    when: ansible_system == 'Linux'
  - name: Install/Upgrade sudo (Debian)
    when: ansible_distribution == 'Debian'
    apt: pkg=sudo state=present
  - name: Add ssh key
    authorized_key: user={{ user }} key="{{ lookup('file', my_ssh_key) }}"
  - name: Add sudo group to sudoers
    lineinfile: dest={{ sudoers }} regexp='%sudo' line='%sudo ALL=(ALL:ALL) ALL'
  - name: Enable rootpw option in sudoers
    lineinfile: dest={{ sudoers }} regexp='rootpw' line='Defaults rootpw'
  - name: Ensure specified user is on sudo group
    user: name={{ user }} state=present groups="{{ user }},sudo"
